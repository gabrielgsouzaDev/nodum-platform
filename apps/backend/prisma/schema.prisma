// prisma/schema.prisma
// Versão 3.8.17 - NODUM KERNEL MASTER (Estabilidade de Produção)
// Foco: Implementação limpa, sem conflitos de extensões e compatibilidade total com Supabase.

generator client {
  previewFeatures = ["driverAdapters"]
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// 1. MÓDULO PLATAFORMA (NODUM Global)
// ==========================================

model PlatformSystem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   
  slug        String   @unique 
  description String?
  status      String   @default("ACTIVE")
  
  schools     School[] 
  
  createdAt   DateTime @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @db.Timestamptz(3)

  @@map("platform_systems")
}

model Plan {
  id              String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  description     String?
  price           Decimal              @db.Decimal(12, 2)
  discountPercent Decimal              @default(0.00) @db.Decimal(5, 2)
  maxStudents     Int                  @default(100)
  maxCanteens     Int                  @default(1)
  status          PlanStatus           @default(ACTIVE)
  features        Json?                
  
  schools         School[]
  planHistory     SchoolPlanHistory[]
  
  createdAt       DateTime             @default(now()) @db.Timestamptz(3)
  updatedAt       DateTime             @updatedAt @db.Timestamptz(3)

  @@index([status])
  @@map("plans")
}

enum PlanStatus {
  ACTIVE
  RETIRED
}

model SchoolPlanHistory {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  schoolId  String    @db.Uuid
  planId    String    @db.Uuid
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  plan      Plan      @relation(fields: [planId], references: [id], onDelete: Restrict)
  startedAt DateTime  @default(now()) @db.Timestamptz(3)
  endedAt   DateTime? @db.Timestamptz(3)

  @@index([schoolId, startedAt])
  @@map("school_plan_histories")
}

// ==========================================
// 2. MÓDULO DE TENANCY (Inquilinos)
// ==========================================

model School {
  id           String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  taxId        String              @unique 
  slug         String              @unique
  customDomain String?             @unique
  status       SchoolStatus        @default(PENDING)
  
  systemId     String              @db.Uuid
  system       PlatformSystem      @relation(fields: [systemId], references: [id], onDelete: Restrict)
  
  planId       String              @db.Uuid
  plan         Plan                @relation(fields: [planId], references: [id], onDelete: Restrict)
  planHistory  SchoolPlanHistory[]
  
  users        User[]
  canteens     Canteen[]
  products     Product[]
  orders       Order[]
  auditLogs    AuditLog[]
  invitations  GuardianInvitation[]
  
  config       Json?               
  
  createdAt    DateTime            @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime            @updatedAt @db.Timestamptz(3)

  @@index([status, slug])
  @@index([systemId])
  @@map("schools")
}

enum SchoolStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELED
}

model Canteen {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  schoolId    String        @db.Uuid
  school      School        @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  status      CanteenStatus @default(ACTIVE)
  
  openingTime String        @default("07:00")
  closingTime String        @default("18:00")
  
  operators     User[]
  products      Product[]
  reservations  StockReservation[]
  inventoryLogs InventoryLog[]
  
  createdAt   DateTime      @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(3)
  deletedAt   DateTime?     @db.Timestamptz(3)

  @@index([schoolId, status])
  @@map("canteens")
}

enum CanteenStatus {
  ACTIVE
  PAUSED
  MAINTENANCE
}

// ==========================================
// 3. IDENTIDADE, CARTEIRA & SEGREDOS
// ==========================================

model User {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  email               String               @unique 
  passwordHash        String               
  document            String?              // Ciphertext (Criptografado na aplicação)
  documentHash        String?              // Unicidade via SQL Partial Index (Prevenção de erro em NULL)
  birthDate           DateTime?            @db.Date
  role                UserRole             @default(STUDENT)
  
  schoolId            String?              @db.Uuid
  school              School?              @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  
  canteenId           String?              @db.Uuid
  canteen             Canteen?             @relation(fields: [canteenId], references: [id], onDelete: SetNull)

  wallet              Wallet?

  guardians           User[]               @relation("UserDependencies")
  dependents          User[]               @relation("UserDependencies")
  
  sentInvitations     GuardianInvitation[] @relation("Sender")
  receivedInvitations GuardianInvitation[] @relation("Receiver")

  ordersAsBuyer       Order[]              @relation("BuyerOrders")
  ordersAsStudent     Order[]              @relation("StudentOrders")
  
  restrictedProducts  ProductRestriction[]
  restrictedCategories CategoryRestriction[]
  favorites           Favorite[]
  auditLogs           AuditLog[]
  
  lastLoginAt         DateTime?            @db.Timestamptz(3)
  createdAt           DateTime             @default(now()) @db.Timestamptz(3)
  updatedAt           DateTime             @updatedAt @db.Timestamptz(3)
  deletedAt           DateTime?            @db.Timestamptz(3)

  @@index([schoolId, role])
  @@map("users")
}

model AuditKey {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  keyAlias  String   @unique @map("key_alias")
  secret    String   @map("secret")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @db.Timestamptz(3) @map("created_at")

  @@map("audit_keys")
}

enum UserRole {
  GLOBAL_ADMIN
  SCHOOL_ADMIN
  CANTEEN_OPERATOR
  GUARDIAN
  STUDENT
}

model GuardianInvitation {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  schoolId    String           @db.Uuid
  school      School           @relation(fields: [schoolId], references: [id])
  senderId    String           @db.Uuid
  sender      User             @relation("Sender", fields: [senderId], references: [id])
  receiverId  String           @db.Uuid
  receiver    User             @relation("Receiver", fields: [receiverId], references: [id])
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime         @updatedAt @db.Timestamptz(3)

  @@unique([senderId, receiverId])
  @@index([schoolId])
  @@map("guardian_invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  REVOKED
}

model Wallet {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String        @unique @db.Uuid
  user             User          @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  balance          Decimal       @default(0.00) @db.Decimal(12, 2)
  version          Int           @default(0) 
  
  dailySpendLimit  Decimal       @default(0.00) @db.Decimal(12, 2)
  canPurchaseAlone Boolean       @default(true)
  canRechargeAlone Boolean       @default(true)
  allowedDays      Int[]         @default([1,2,3,4,5]) 
  
  transactions     Transaction[]
  dailySpending    DailySpend[]

  updatedAt        DateTime      @updatedAt @db.Timestamptz(3)
  
  @@map("wallets")
}

model Transaction {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId       String            @db.Uuid
  wallet         Wallet            @relation(fields: [walletId], references: [id], onDelete: Restrict)
  
  amount         Decimal           @db.Decimal(12, 2)
  runningBalance Decimal           @db.Decimal(12, 2) 
  
  type           TransactionType
  status         TransactionStatus @default(PENDING)
  description    String?
  externalId     String?           
  
  orderId        String?           @db.Uuid
  order          Order?            @relation(fields: [orderId], references: [id])
  
  createdAt      DateTime          @default(now()) @db.Timestamptz(3)

  @@index([walletId, createdAt(sort: Desc)])
  @@index([orderId])
  @@map("transactions")
}

enum TransactionType {
  RECHARGE
  PURCHASE
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

// ==========================================
// 4. INVENTÁRIO & VENDAS
// ==========================================

model Product {
  id            String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  price         Decimal              @db.Decimal(12, 2)
  salePrice     Decimal?             @db.Decimal(12, 2)
  stock         Int                  @default(0)
  version       Int                  @default(0) 
  minStockAlert Int                  @default(5)
  category      String
  imageUrl      String?
  isKit         Boolean              @default(false)
  isAvailable   Boolean              @default(true)
  
  canteenId     String               @db.Uuid
  canteen       Canteen              @relation(fields: [canteenId], references: [id])
  schoolId      String               @db.Uuid
  school        School               @relation(fields: [schoolId], references: [id])
  
  kitComponents KitItem[]            @relation("KitToComponent")
  partOfKits    KitItem[]            @relation("ComponentToKit")
  
  reservations  StockReservation[]
  inventoryLogs InventoryLog[]
  orderItems    OrderItem[]
  restrictions  ProductRestriction[]
  favorites     Favorite[]

  createdAt     DateTime             @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime             @updatedAt @db.Timestamptz(3)
  deletedAt     DateTime?            @db.Timestamptz(3)

  @@index([canteenId])
  @@index([schoolId])
  @@map("products")
}

model KitItem {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  kitId       String  @db.Uuid
  componentId String  @db.Uuid
  quantity    Int     @default(1)
  
  kit         Product @relation("KitToComponent", fields: [kitId], references: [id])
  component   Product @relation("ComponentToKit", fields: [componentId], references: [id])

  @@index([kitId])
  @@map("kit_items")
}

model StockReservation {
  id         String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId  String            @db.Uuid
  product    Product           @relation(fields: [productId], references: [id])
  canteenId  String            @db.Uuid
  canteen    Canteen           @relation(fields: [canteenId], references: [id])
  quantity   Int
  reason     ReservationReason @default(CHECKOUT)
  status     ReservationStatus @default(ACTIVE)
  expiresAt  DateTime          @db.Timestamptz(3)
  createdAt  DateTime          @default(now()) @db.Timestamptz(3)

  @@index([expiresAt, status])
  @@index([canteenId])
  @@map("stock_reservations")
}

enum ReservationStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ReservationReason {
  CHECKOUT
  REFUND_PENDING
  DAMAGED
}

model InventoryLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId  String   @db.Uuid
  product    Product  @relation(fields: [productId], references: [id])
  canteenId  String   @db.Uuid
  canteen    Canteen  @relation(fields: [canteenId], references: [id])
  change     Int      
  reason     String   
  createdAt  DateTime @default(now()) @db.Timestamptz(3)

  @@index([productId])
  @@index([canteenId])
  @@map("inventory_logs")
}

model Order {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderHash   String      @unique
  totalAmount Decimal     @db.Decimal(12, 2)
  status      OrderStatus @default(PENDING)
  
  buyerId     String      @db.Uuid
  buyer       User        @relation("BuyerOrders", fields: [buyerId], references: [id])
  studentId   String      @db.Uuid
  student     User        @relation("StudentOrders", fields: [studentId], references: [id])
  
  schoolId    String      @db.Uuid
  school      School      @relation(fields: [schoolId], references: [id])
  
  transactions Transaction[]
  items        OrderItem[]
  
  deliveredAt DateTime?   @db.Timestamptz(3)
  createdAt   DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(3)

  @@index([schoolId, createdAt(sort: Desc)])
  @@index([studentId])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  DELIVERED
  CANCELLED
}

model OrderItem {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String  @db.Uuid
  productId String  @db.Uuid
  quantity  Int
  unitPrice Decimal @db.Decimal(12, 2) 
  
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@map("order_items")
}

model DailySpend {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  walletId String   @db.Uuid
  wallet   Wallet   @relation(fields: [walletId], references: [id])
  date     DateTime @db.Date
  amount   Decimal  @db.Decimal(12, 2)

  @@unique([walletId, date])
  @@index([walletId, date(sort: Desc)])
  @@map("daily_spending")
}

model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  schoolId     String   @db.Uuid
  school       School   @relation(fields: [schoolId], references: [id])
  userId       String?  @db.Uuid
  user         User?    @relation(fields: [userId], references: [id])
  action       String
  entity       String
  entityId     String?
  meta         Json?
  ip           String?
  logHash      String?  
  previousHash String?  
  createdAt    DateTime @default(now()) @db.Timestamptz(3)

  @@index([schoolId, createdAt(sort: Desc)])
  @@index([previousHash])
  @@map("audit_logs")
}

model ProductRestriction {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String  @db.Uuid
  productId String  @db.Uuid
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("product_restrictions")
}

model CategoryRestriction {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String @db.Uuid
  category String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@map("category_restrictions")
}

model Favorite {
  userId    String  @db.Uuid
  productId String  @db.Uuid
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([userId, productId])
  @@map("favorites")
}